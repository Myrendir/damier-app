import * as React from "react";
import PropTypes from "prop-types";
import SquareDecorator from "../SquareDecorator";
import SquareDetails from "../SquareDetails";
import {useStore} from "react-context-hook";
import get_quality_environment from "../../services/qualityEnvironmentService";
import {useEffect, useState} from "react";

export default function DetailsExploitation({color, ...props}) {
    const [date] = useStore("date");
    const [nbAccidentsMateriels, setNbAccidentsMateriels] = useState(0);
    const [nbAccidentsCorporels, setNbAccidentsCorporels] = useState(0);
    const [causeAccident, setCauseAccident] = useState("");
    const [tauxControle, setTauxControle] = useState(0);
    function getLastDayOfMonth(year, month) {
        return new Date(year, month + 1, 0);
    }
    useEffect(
        () => {
            if (date != 0) {
                let newDate = new Date(date);
                let endDate = getLastDayOfMonth(newDate.getFullYear(), newDate.getMonth());
                endDate = endDate.toISOString().split('T')[0];
                get_quality_environment(endDate).then(
                    r => {
                        let nbAccidentsMaterielsInside = 0;
                        let nbAccidentsCorporelsInside = 0;
                        let tauxControleInside = 0;
                        let human = 0;
                        let info = 0;
                        let itemp = 0;

                        r.data.forEach(item => {
                            nbAccidentsMaterielsInside += item.nbAccidentsMateriels;
                            nbAccidentsCorporelsInside += item.nbAccidentsCorporels;
                            tauxControleInside += item.tauxControle;
                            if (item.causeAccident === "HUMAINE") {
                                human++
                            }
                            if (item.causeAccident === "INTEMPÉRIE") {
                                itemp++
                            }
                            if (item.causeAccident === "INFORMATIQUE") {
                                info++
                            }
                        })
                        let res = [human, itemp, info];

                        setNbAccidentsMateriels(nbAccidentsMaterielsInside);
                        setNbAccidentsCorporels(nbAccidentsCorporelsInside);
                        setTauxControle(tauxControleInside);

                    }
                )
            } else {
                get_quality_environment().then(
                    r => {
                        let nbAccidentsMaterielsInside = 0;
                        let nbAccidentsCorporelsInside = 0;
                        let tauxControleInside = 0;
                        let human = 0;
                        let info = 0;
                        let itemp = 0;

                        r.data.forEach(item => {
                            nbAccidentsMaterielsInside += item.nbAccidentsMateriels;
                            nbAccidentsCorporelsInside += item.nbAccidentsCorporels;
                            tauxControleInside += item.tauxControle;
                            if (item.causeAccident === "HUMAINE") {
                                human++
                            }
                            if (item.causeAccident === "INTEMPÉRIE") {
                                itemp++
                            }
                            if (item.causeAccident === "INFORMATIQUE") {
                                info++
                            }
                        })
                        let res = [human, itemp, info];

                        console.log(Object.values(res))
                        setNbAccidentsMateriels(nbAccidentsMaterielsInside);
                        setNbAccidentsCorporels(nbAccidentsCorporelsInside);
                        setTauxControle(tauxControleInside);

                    }
                )

            }

        },
        [date]
    )
    return (
        <div style={styles.columns} {...props}>
            <div style={styles.box}>
                <SquareDecorator color="#3a56a3"/>
                <SquareDetails btnColor="#094f66" color="#f8f8f8" title={"Nb d'accidents matériels"} icon={"/ticket.svg"}/>
                <SquareDecorator color="#272472"/>
            </div>
            <div style={styles.box}>
                <SquareDetails color="#f8f8f8" btnColor="#094f66" icon={"/ticket.svg"}/>
                <SquareDecorator color="#bcd8ef"/>
                <SquareDetails color="#f8f8f8" icon={"/ticket.svg"} btnColor="#094f66"/>
            </div>

            <div style={styles.box}>
                <SquareDecorator color="#79b0e0"/>
                <SquareDetails btnColor="#094f66" color="#f8f8f8" icon={"/ticket.svg"}/>
                <SquareDecorator color="#4887c6"/>
            </div>
        </div>
    );
}

const styles = {
    columns: {
        display: "flex",
        flexDirection: "column",
        justifyContent: "center",
        width: "100%",
    },
    box: {
        display: "flex",
        justifyContent: "center",
        width: "100%",
        flexDirection: "row",
        flexWrap: "wrap",
        height: "100%"
    },
};

DetailsExploitation.propTypes = {
    color: PropTypes.string,
};

DetailsExploitation.defaultProps = {
    color: "",
};
